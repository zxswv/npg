# 本番用のサーバー構築

## まず最初に

### .env

```bash
# 開発環境ではこちらを使う
# DATABASE_URL="postgresql://tt:tt@localhost:5432/DB?schema=public"

# DIRECT_URL="postgresql://tt:tt@localhost:5432/DB?schema=public"


# ↓ 以下のURLはnextサーバーを使う際の.env
DATABASE_URL="postgresql://tt:tt@2mongodb:5432/DB?schema=public"

DIRECT_URL="postgresql://tt:tt@2mongodb:5432/DB?schema=public"
```

[docker-compose-prod.yml](/npg/docker-compose-prod.yml)  
[docker-compose.yml](/npg/docker-compose.yml)  
以上二つのコメントアウトを外す

一度 docker をリセットします

```bash
docker-compose down #すべて削除
docker login #すでにログイン済みなら不要   ・ログインが出来ていないと起動時に(Dockerfile.next.jsのFROM node:20-bullseye)についてのエラーが出る
docker-compose up --build #すべて立ち上げる、立ち上がらない場合は大抵dockerにログインできていない。
```

これで docker 上に立てた環境にアクセスできる。

# 次にスマホでアクセスする際のことを説明する。

まずターミナルに出てくる  
2next.js | - Local: http://localhost:3300  
2next.js | - Network: http://172.19.0.3:3300  
この二つはスマホでアクセスしても表示されない。

スマホからのアクセスは PC の IP アドレスを使う。

### windows の場合： 1.ターミナルを開く

```bash
ipconfig
```

実行結果にある  
「IPv4 アドレス」の項目の右にある  
192.168.x.x や 10.0.x.x をメモする。（例: 192.168.1.5）

### macOS の場合:

1.ターミナルを開きます。

```bash
ipconfig getifaddr en0
```

# スマホの接続

```bash
http://<さっき調べたPCのIPアドレス>:<ポート番号>
```

具体例:
もし、さっき調べた PC の IP アドレスが 192.168.1.5 で、
Next.js のポート番号が 3300 ならば、

スマホのブラウザには、
http://192.168.1.5:3300
と入力してアクセスします。

# ファイアウォールの設定（もし繋がらない場合）

アクセスできない場合、PC のファイアウォールが外部からの 3300 番ポートへのアクセスをブロックしている可能性があります。

### Windows の場合:

> 1.Windows の検索で「セキュリティが強化された Windows Defender ファイアウォール」と入力して開きます。
>
> 2.左側のパネルで「**受信の規則**」を選択します。
>
> 3.右側のパネルで「**新しい規則...**」をクリックします。
>
> 4.「**規則の種類**」で「**ポート**」を選択し、「次へ」。
>
> 5.「**プロトコルおよびポート**」で「**TCP**」を選択し、「**特定のローカル ポート**」に「**3300**」と入力して、「次へ」。
>
> 6.「**操作**」で「**接続を許可する**」を選択し、「次へ」。
>
> 7.「**プロファイル**」で「**プライベート**」と「**パブリック**」の両方にチェックが入っていることを確認し、「次へ」。（通常は「プライベート」だけで十分です）
>
> 8.「**名前**」に「Next.js Dev Server (3300)」のような分かりやすい名前を付けて、「完了」をクリックします。

この設定を追加した後、もう一度スマホからアクセスを試してみてください。

### まとめ:

1.PC とスマホを同じ Wi-Fi に繋ぐ。

2.PC の Wi-Fi IP アドレス（例: 192.168.1.5）を調べる。

3.スマホのブラウザで http://<PC の IP アドレス>:3300 にアクセスする。

4.（それでもダメなら）PC のファイアウォールで 3300 番ポートの受信を許可する。

## 追記

本番環境は docker 上に開発環境と同じものを Next.js サーバーとして構築しているので**変更をしても反映されません**。
なので変更を適応したい場合、一度 Next.js サーバーをクリアして構築し直さないといけません。

```bash
docker-compose down #docker上のサーバーをクリア
docker-compose up --build #すべて立ち上げる
```
